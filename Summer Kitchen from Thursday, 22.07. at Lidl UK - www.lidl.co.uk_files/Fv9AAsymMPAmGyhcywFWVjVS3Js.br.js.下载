(function(){var e,r;try{var n=window.$MicrosoftMaps8,s=n.Internal,a=n.Anchor,v=s._Helper,h=n.Layer,c=n.Location,i=n.PixelReference,u=n.Point,l=n.Pushpin,f=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),t;(function(n){n[n.meanAverage=0]="meanAverage";n[n.gridCenter=1]="gridCenter";n[n.firstLocation=2]="firstLocation";n[n.MeanAverage=0]="MeanAverage";n[n.GridCenter=1]="GridCenter";n[n.FirstLocation=2]="FirstLocation"})(t||(t={}));e=function(n){function e(t,i){var u=this,r;return i?(r={},r.gridSize=i.gridSize||e._defaultOptions.gridSize,r.clusterPlacementType=i.clusterPlacementType||e._defaultOptions.clusterPlacementType,r.layerOffset=i.layerOffset||e._defaultOptions.layerOffset,r.clusteringEnabled=typeof i.clusteringEnabled=="boolean"?i.clusteringEnabled:e._defaultOptions.clusteringEnabled,r.clusteredPinCallback=i.clusteredPinCallback,r.callback=i.callback,r.zIndex=typeof i.zIndex=="number"?i.zIndex:e._defaultOptions.zIndex,r.visible=typeof i.visible=="boolean"?i.visible:undefined):r=e._defaultOptions,u=n.call(this,"ClusterLayer_"+e._clusterLayerId++,r.zIndex)||this,u._options=r,u._pushpins=t,typeof r.visible=="boolean"&&u.setVisible(r.visible),u}return f(e,n),e.prototype.attachMap=function(n){var t=this,i;if(this._map)throw new Error("Cluster layer is already attached to an existing map");this._map=n;i=this._map.getV8Map().getFrameManager();i?(this._cluster(),this._onFrameManagerLoaded(),this._mapTypeChangedHandler=this._map.getV8Map().mapTypeChanged.add(function(){return t._onFrameManagerLoaded()})):this._map.getV8Map().frameManagerLoaded.addOne(function(){t._cluster();t._onFrameManagerLoaded();t._mapTypeChangedHandler=t._map.getV8Map().mapTypeChanged.add(function(){return t._onFrameManagerLoaded()})})},e.prototype.detachMap=function(n){if(this._map&&this._map!==n)throw new Error("Cannot remove cluster layer from this map since it's attached to another map instance");var t=n._v8Map.getLayers().remove(this);this._map=null;this._refreshViewHandler&&this._refreshViewHandler.dispose();this._mapTypeChangedHandler&&this._mapTypeChangedHandler.dispose()},e.prototype.clear=function(){n.prototype.clear.call(this);this._pushpins=[]},e.prototype.getOptions=function(){return this._options},e.prototype.setOptions=function(n){for(var t,r=Object.keys(this._options),i=0,u=r.length;i<u;i++)t=r[i],typeof n[t]=="undefined"&&(n[t]=this._options[t]);this._options=n;typeof this._options.visible=="boolean"&&this.setVisible(this._options.visible);this._cluster(!0)},e.prototype.getPushpins=function(){return this._pushpins},e.prototype.setPushpins=function(n){this._pushpins=n;this._cluster(!0)},e.prototype.getDisplayedPushpins=function(){var n,r,t,i;if(this._options.clusteringEnabled){for(n=[],r=this._primitives.length,t=0;t<r;t++)i=this._primitives[t],i.containedPushpins?n=n.concat(i.containedPushpins):n.push(this._primitives[t]);return n}return this._pushpins},e.prototype.getClusterPushpinByGridKey=function(n){var i,t;if(this._options.clusteringEnabled)for(i=this._primitives.length,t=0;t<i;t++)if(this._primitives[t].gridKey===n)return this._primitives[t];return null},e.prototype._onFrameManagerLoaded=function(){var n=this;this._refreshViewHandler=this._map.viewchangeend.add(function(){return n._cluster()})},e.prototype._cluster=function(n){var r,s,u,h,l,o,k,f,a,y,t;if(this._map&&(this._map._v8Map.getView()!==this._clusterView||n===!0)){if(this._clusterView=this._map._v8Map.getView(),r=this._pushpins,this._options.clusteringEnabled){var v=[],p=this._map.getWidth(),w=this._map.getHeight();if(this._numXGrids=Math.ceil(p/this._options.gridSize)+1,this._numYGrids=Math.ceil(w/this._options.gridSize)+1,s=this._map.tryLocationToPixel(new c(0,0),i.control),s===null)return;var b={x:s.x%this._options.gridSize,y:s.y%this._options.gridSize},e=new Array(this._numXGrids*this._numYGrids),y=r.length;for(t=0;t<y;t++)r[t].gridKey=null,u=this._map.tryLocationToPixel(r[t].getLocation(),i.control),u&&u.x<=p+this._options.gridSize&&u.y<=w+this._options.gridSize&&u.x>=-1*this._options.gridSize&&u.y>=-1*this._options.gridSize&&(h=Math.floor((u.x+this._options.gridSize-b.x)/this._options.gridSize),l=Math.floor((u.y+this._options.gridSize-b.y)/this._options.gridSize),h<this._numXGrids&&l<this._numYGrids&&h>=0&&l>=0&&(o=h+l*this._numXGrids,e[o]||(e[o]=[]),e[o].push(r[t]),r[t].gridKey=o));for(k=e.length,t=0;t<k;t++)f=e[t],f&&(f.length>1?(a=this._getClusteredPushpin(f,t),this._options.clusteredPinCallback&&this._options.clusteredPinCallback(a)):f.length===1&&(a=f[0]),v.push(a))}else for(v=r,y=r.length,t=0;t<y;t++)r[t].gridKey=null;this.clear();this.add(v);this._pushpins=r;this._options.callback&&this._options.callback()}},e.prototype._getClusteredPushpin=function(n,f){var e,s,l;switch(this._options.clusterPlacementType){case t.meanAverage:var o=n.length,h=0,c=0;for(e=0;e<o;e++)s=this._map.tryLocationToPixel(n[e].getLocation(),i.control),h+=s.x,c+=s.y;return l=this._map.tryPixelToLocation(new u(h/o,c/o),i.control),new r(n,f,l);case t.gridCenter:var a=(f%this._numXGrids+.5)*this._options.gridSize+this._options.layerOffset.x,v=(Math.floor(f/this._numYGrids)+.5)*this._options.gridSize+this._options.layerOffset.y,y=this._map.tryPixelToLocation(new u(a,v),i.control);return new r(n,f,y);case t.firstLocation:default:return new r(n,f,n[0].getLocation())}},e._defaultOptions={gridSize:45,clusterPlacementType:t.meanAverage,layerOffset:new u(0,0),clusteringEnabled:!0,zIndex:1e4},e._clusterLayerId=0,e}(h);r=function(n){function t(t,i,r){var u=n.call(this,r,{text:t.length.toString()})||this;return u.containedPushpins=t,u.gridKey=i,u}return f(t,n),t}(l);n.ClusterLayer=e;n.ClusterPlacementType=t;n.ClusterPushpin=r}catch(o){if(n.logger)n.logger.logCriticalError(o);else throw o;}}).call(window)